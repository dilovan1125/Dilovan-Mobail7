<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ğŸ’° Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</title>
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
<style>
body{font-family:"Cairo",sans-serif;margin:0;background:#f0f6ff;color:#333;direction:rtl;}
header{background:#1976d2;color:white;padding:20px;text-align:center;font-size:24px;font-weight:bold;}
nav{display:flex;justify-content:space-around;background:#2196f3;padding:12px;}
nav button{background:white;color:#1976d2;border:none;padding:12px 18px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;}
nav button.active{background:#0d47a1;color:white;}
section{display:none;max-width:950px;margin:20px auto;background:white;padding:20px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,0.15);}
section.active{display:block;animation:fadeIn 0.3s ease;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
label{display:block;margin-top:12px;font-weight:bold;color:#0d47a1;}
input,button.action{margin-top:6px;padding:10px;font-size:16px;width:100%;border-radius:6px;border:1px solid #bbb;box-sizing:border-box;}
button.action{background:#1976d2;color:white;border:none;font-weight:bold;cursor:pointer;}
button.action:hover{background:#0d47a1;}
table{width:100%;border-collapse:collapse;margin-top:15px;font-size:15px;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;}
th{background:#e3f2fd;}
.btn-sm{padding:4px 8px;border:none;border-radius:6px;cursor:pointer;font-size:14px;}
.btn-edit{background:#3498db;color:#fff;}
.btn-del{background:#e74c3c;color:#fff;}
.profit-box{font-size:22px;font-weight:bold;color:#16a34a;margin-top:20px;}
#scannerModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:999;}
#scannerBox{background:#fff;padding:10px;border-radius:10px;position:relative;width:320px;height:280px;display:flex;flex-direction:column;align-items:center;}
#scannerBox video{width:100%;height:100%;object-fit:cover;border-radius:8px;}
#closeScan{position:absolute;top:5px;right:5px;background:#e74c3c;color:#fff;border:none;padding:6px 10px;border-radius:6px;font-weight:bold;cursor:pointer;}
</style>
</head>
<body>

<header>ğŸ’° Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</header>
<nav>
  <button onclick="showPage('sell')" id="btn-sell" class="active">ğŸ›’ Ø§Ù„Ø¨ÙŠØ¹</button>
  <button onclick="showPage('products')" id="btn-products">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
  <button onclick="showPage('check')" id="btn-check">ğŸ” Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø³Ø¹Ø±</button>
  <button onclick="showPage('history')" id="btn-history">ğŸ“‘ Ø§Ù„Ø³Ø¬Ù„</button>
  <button onclick="showPage('profit')" id="btn-profit">ğŸ“ˆ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</button>
</nav>

<div id="scannerModal">
  <div id="scannerBox">
    <button id="closeScan" onclick="stopScanner()">âœ– Ø¥ØºÙ„Ø§Ù‚</button>
    <video id="preview" autoplay playsinline></video>
  </div>
</div>

<section id="sell" class="active">
  <h2>ğŸ›’ Ø§Ù„Ø¨ÙŠØ¹</h2>
  <label>ğŸ“¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
  <input id="sellBarcode">
  <button class="action" onclick="startScanner('sell')">ğŸ“· Ù…Ø³Ø­</button>
  <label>ğŸ“› Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
  <input id="sellName" readonly>
  <label>ğŸ”¢ Ø§Ù„ÙƒÙ…ÙŠØ©</label>
  <input id="sellQty" type="number" value="1">
  <label>ğŸ’² Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</label>
  <input id="sellPrice" type="number">
  <button class="action" onclick="processSale()">âœ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨ÙŠØ¹</button>
</section>

<section id="products">
  <h2>ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
  <label>ğŸ“¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
  <input id="pbarcode">
  <button class="action" onclick="startScanner('product')">ğŸ“· Ù…Ø³Ø­</button>
  <label>ğŸ“› Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
  <input id="pname">
  <label>ğŸ’² Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©</label>
  <input id="pcost" type="number">
  <label>ğŸ’² Ø³Ø¹Ø± Ø§Ù„Ù…Ø¨ÙŠØ¹</label>
  <input id="psell" type="number">
  <label>ğŸ”¢ Ø§Ù„ÙƒÙ…ÙŠØ©</label>
  <input id="pstock" type="number">
  <button class="action" onclick="addProduct()">â• Ø¥Ø¶Ø§ÙØ© / ØªØ­Ø¯ÙŠØ«</button>

  <table id="productsTable">
    <thead>
      <tr><th>Ø¨Ø§Ø±ÙƒÙˆØ¯</th><th>Ø§Ø³Ù…</th><th>ØªÙƒÙ„ÙØ©</th><th>Ù…Ø¨ÙŠØ¹</th><th>ÙƒÙ…ÙŠØ©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <p>ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©: <span id="totalStock">0</span></p>
  <p>ğŸ’µ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: <span id="totalCost">0</span></p>
</section>

<section id="check">
  <h2>ğŸ” Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø³Ø¹Ø±</h2>
  <label>ğŸ“¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
  <input id="checkBarcode" oninput="checkPrice()">
  <button class="action" onclick="startScanner('check')">ğŸ“· Ù…Ø³Ø­</button>
  <div id="checkResult" style="margin-top:15px;font-size:18px;font-weight:bold;color:#0d47a1;"></div>
</section>

<section id="history">
  <h2>ğŸ“‘ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h2>
  <table id="historyTable">
    <thead>
      <tr><th>Ø¨Ø§Ø±ÙƒÙˆØ¯</th><th>Ø§Ø³Ù…</th><th>ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø±</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>ØªØ§Ø±ÙŠØ®</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section id="profit">
  <h2>ğŸ“ˆ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</h2>
  <div class="profit-box">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­: <span id="totalProfit">0</span></div>
</section>

<script>
localforage.config({name:'shopdb'});
const prodStore=localforage.createInstance({name:'shopdb',storeName:'products'});
const saleStore=localforage.createInstance({name:'shopdb',storeName:'sales'});
let products=[],sales=[];
let codeReader=new ZXing.BrowserMultiFormatReader();
let currentStream=null, scannerMode=null;

function showPage(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.getElementById("btn-"+id).classList.add("active");
  if(id==="products") loadProducts();
  if(id==="history"||id==="profit") loadSales();
}

async function startScanner(mode){
  scannerMode=mode;
  document.getElementById("scannerModal").style.display="flex";
  try{
    const constraints={video:{facingMode:"environment"}};
    currentStream=await navigator.mediaDevices.getUserMedia(constraints);
    document.getElementById("preview").srcObject=currentStream;
    codeReader.decodeFromVideoDevice(null,"preview",(res,err)=>{
      if(res){ handleScan(res.text); }
    });
  }catch(e){
    alert("âŒ Ù„Ù… ÙŠØªÙ… ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");
    document.getElementById("scannerModal").style.display="none";
  }
}
function stopScanner(){
  try{ codeReader.reset(); }catch(e){}
  if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); }
  document.getElementById("scannerModal").style.display="none";
}
function handleScan(code){
  if(scannerMode==="sell"){ sellBarcode.value=code; loadProductName(code); }
  if(scannerMode==="product"){ pbarcode.value=code; }
  if(scannerMode==="check"){ checkBarcode.value=code; checkPrice(); }
  stopScanner();
}

/* Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª */
async function addProduct(){
  let p={barcode:pbarcode.value.trim(),name:pname.value.trim(),cost:+pcost.value||0,sell:+psell.value||0,stock:+pstock.value||0};
  if(!p.barcode) return alert("âŒ Ø£Ø¯Ø®Ù„ Ø¨Ø§Ø±ÙƒÙˆØ¯");
  await prodStore.setItem(p.barcode,p);
  pbarcode.value=pname.value=pcost.value=psell.value=pstock.value="";
  loadProducts();
}
async function loadProducts(){
  products=[]; await prodStore.iterate(v=>products.push(v));
  let t=document.querySelector("#productsTable tbody"); t.innerHTML="";
  let totalQty=0,totalCost=0;
  products.forEach(p=>{
    totalQty+=p.stock;
    totalCost+=p.cost * p.stock;
    t.innerHTML+=`<tr>
      <td>${p.barcode}</td><td>${p.name}</td><td>${p.cost}</td><td>${p.sell}</td><td>${p.stock}</td>
      <td>
        <button class="btn-sm btn-edit" onclick="editProduct('${p.barcode}')">âœï¸</button>
        <button class="btn-sm btn-del" onclick="deleteProduct('${p.barcode}')">ğŸ—‘</button>
      </td>
    </tr>`;
  });
  document.getElementById("totalStock").textContent=totalQty;
  document.getElementById("totalCost").textContent=totalCost;
}
async function editProduct(code){
  let p=await prodStore.getItem(code);
  if(!p) return;
  pbarcode.value=p.barcode; pname.value=p.name; pcost.value=p.cost;
  psell.value=p.sell; pstock.value=p.stock;
}
async function deleteProduct(code){
  if(!confirm("âŒ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) return;
  await prodStore.removeItem(code);
  loadProducts();
}

/* Ø§Ù„Ø¨ÙŠØ¹ */
async function loadProductName(barcode){
  let p=await prodStore.getItem(barcode);
  sellName.value=p? p.name : "âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
}
async function processSale(){
  let b=sellBarcode.value.trim(), q=+sellQty.value||1, pr=+sellPrice.value||0;
  if(!b) return alert("âŒ Ø£Ø¯Ø®Ù„ Ø¨Ø§Ø±ÙƒÙˆØ¯");
  let p=await prodStore.getItem(b);
  if(!p) return alert("âŒ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
  if(p.stock<q) return alert("âŒ Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± ÙƒØ§ÙÙŠ");
  p.stock-=q; await prodStore.setItem(b,p);
  let s={id:Date.now(),barcode:b,name:p.name,qty:q,price:pr,total:q*pr,cost:p.cost,date:new Date().toLocaleString()};
  await saleStore.setItem(s.id,s);
  alert("âœ” ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹: "+p.name);
  sellBarcode.value=sellName.value=sellPrice.value=""; sellQty.value=1;
  loadSales();
}

/* Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø³Ø¹Ø± */
async function checkPrice(){
  let b=checkBarcode.value.trim();
  if(!b){ checkResult.textContent=""; return; }
  let p=await prodStore.getItem(b);
  checkResult.textContent=p? `ğŸ’² Ø³Ø¹Ø± Ø§Ù„Ù…Ø¨ÙŠØ¹: ${p.sell}` : "âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
}

/* Ø§Ù„Ø³Ø¬Ù„ + ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ */
async function loadSales(){
  sales=[]; await saleStore.iterate(v=>sales.push(v));
  sales.sort((a,b)=>b.id-a.id);
  let t=document.querySelector("#historyTable tbody"); t.innerHTML="";
  let profit=0;
  sales.forEach(s=>{
    profit += (s.price - s.cost) * s.qty;
    t.innerHTML+=`<tr id="row_${s.id}">
      <td>${s.barcode}</td><td>${s.name}</td><td>${s.qty||1}</td>
      <td>${s.price}</td><td>${s.total}</td><td>${s.date}</td>
      <td>
        <button class="btn-sm btn-edit" onclick="editSale(${s.id})">âœï¸</button>
        <button class="btn-sm btn-del" onclick="deleteSale(${s.id})">ğŸ—‘</button>
      </td>
    </tr>`;
  });
  document.getElementById("totalProfit").textContent = profit;
}
async function editSale(id){
  let s=await saleStore.getItem(id); if(!s) return;
  let tr=document.getElementById("row_"+id);
  tr.innerHTML=`<td>${s.barcode}</td><td>${s.name}</td>
    <td><input id="e_qty_${id}" type="number" value="${s.qty||1}" style="width:60px"></td>
    <td><input id="e_price_${id}" type="number" value="${s.price}" style="width:80px"></td>
    <td>${s.total}</td><td>${s.date}</td>
    <td><button onclick="saveSale(${id})">ğŸ’¾</button><button onclick="loadSales()">â†©</button></td>`;
}
async function saveSale(id){
  let s=await saleStore.getItem(id); if(!s) return;
  let newQty=+document.getElementById("e_qty_"+id).value||1;
  let newPrice=+document.getElementById("e_price_"+id).value||0;
  s.qty=newQty; s.price=newPrice; s.total=newQty*newPrice;
  await saleStore.setItem(id,s); loadSales();
}
async function deleteSale(id){
  if(!confirm("âŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ")) return;
  await saleStore.removeItem(id); loadSales();
}

/* ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù (ÙŠÙØ³ØªØ®Ø¯Ù… Ù„ØªØµØ¯ÙŠØ± Excel Ø¥Ø°Ø§ Ø£Ø¶ÙÙ†Ø§Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹) */
function downloadFile(name,content,type){
  const blob=new Blob([content],{type});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download=name; a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
